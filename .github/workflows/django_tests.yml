name: Django Tests with Docker Compose

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Create .env file for tests
      run: |
        cat > .env << EOF
        # Configurações do Django
        DEBUG=True
        SECRET_KEY=your_secret_key
        DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,coinflip.com,www.coinflip.com

        # Configurações do Banco de Dados
        DB_NAME=Django_APP
        DB_USER=django
        DB_PASSWORD=your_password
        DB_HOST=db
        DB_PORT=3306
        MYSQL_ROOT_PASSWORD=your_root_password
        EOF
    
    - name: Start containers with docker-compose
      run: |
        docker compose up -d
    
    - name: Wait for MySQL to be ready (improved)
      run: |
        for i in {1..30}; do
          echo "Tentativa $i/30..."
          docker compose exec -T db mysqladmin ping -h localhost -u root -p"$MYSQL_ROOT_PASSWORD" && break
          sleep 2
        done
      timeout-minutes: 2
    
    - name: Wait for Django container to be ready
      run: |
        docker compose exec -T web sh -c 'for i in {1..20}; do python manage.py check && break || (echo "Tentativa $i/20" && sleep 2); done'
      timeout-minutes: 2
    
    - name: Grant permissions to Django user
      run: |
        docker compose exec -T db mysql -h localhost -u root -p"$MYSQL_ROOT_PASSWORD" << EOF
        GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'%';
        GRANT ALL PRIVILEGES ON \`test_${DB_NAME}\`.* TO '${DB_USER}'@'%';
        GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'localhost';
        GRANT ALL PRIVILEGES ON \`test_${DB_NAME}\`.* TO '${DB_USER}'@'localhost';
        FLUSH PRIVILEGES;
        EOF
      env:
        DB_NAME: Django_APP
        DB_USER: django
      timeout-minutes: 1
    
    - name: Run migrations in container
      run: |
        docker compose exec -T web sh -c 'cd /app/Projeto_1_Nuvem && python manage.py migrate'
    
    - name: Run Unit Tests
      run: |
        docker compose exec -T web sh -c 'cd /app/Projeto_1_Nuvem && python manage.py test users.test_models transactions.test_models users.test_views transactions.test_views --verbosity=2'
    
    - name: Run Integration Tests
      run: |
        docker compose exec -T web sh -c 'cd /app/Projeto_1_Nuvem && python manage.py test test_integration test_additional_integration --verbosity=2'
    
    - name: Run tests with coverage
      run: |
        docker compose exec -T web sh -c 'cd /app/Projeto_1_Nuvem && coverage run --source="." manage.py test && coverage report && coverage xml'
    
    - name: Copy coverage report from container
      if: always()
      run: |
        docker compose cp web:/app/Projeto_1_Nuvem/coverage.xml ./coverage.xml || true
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          coverage.xml
    
    - name: Stop and clean up containers
      if: always()
      run: |
        docker compose down -v
